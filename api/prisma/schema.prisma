generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Merchant {
  id           String   @id @default(cuid())
  bch_address  String   @unique
  business_name String
  email        String?
  logo_url     String?
  api_key_hash String?
  webhook_url      String?
  display_currency String   @default("BCH")
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  payment_links      PaymentLink[]
  invoices           Invoice[]
  transactions       Transaction[]
  webhooks           Webhook[]
  api_keys           ApiKey[]
  devices            Device[]
  cashtoken_configs  CashtokenConfig[]
  contract_instances ContractInstance[]
  token_issuances    TokenIssuance[]
  receipt_nfts       ReceiptNFT[]
  checkout_sessions  CheckoutSession[]

  @@map("merchants")
}

enum PaymentLinkType {
  SINGLE
  MULTI
  RECURRING
}

enum PaymentLinkStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

model PaymentLink {
  id               String            @id @default(cuid())
  merchant_id      String
  amount_satoshis  BigInt
  currency         String            @default("BCH")
  memo             String?
  type             PaymentLinkType   @default(SINGLE)
  status           PaymentLinkStatus @default(ACTIVE)
  slug             String            @unique
  payment_address    String?
  derivation_index   Int?
  recurring_interval String?
  recurring_count    Int               @default(0)
  last_paid_at       DateTime?
  contract_instance_id String?
  expires_at         DateTime?
  created_at         DateTime          @default(now())

  merchant          Merchant          @relation(fields: [merchant_id], references: [id])
  transactions      Transaction[]
  contract_instance ContractInstance? @relation(fields: [contract_instance_id], references: [id])
  checkout_sessions CheckoutSession[]

  @@index([merchant_id])
  @@index([slug])
  @@map("payment_links")
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
}

model Invoice {
  id             String        @id @default(cuid())
  merchant_id    String
  customer_email String?
  items          Json
  total_satoshis BigInt
  status         InvoiceStatus @default(DRAFT)
  due_date       DateTime?
  paid_at        DateTime?
  created_at     DateTime      @default(now())

  merchant     Merchant      @relation(fields: [merchant_id], references: [id])
  transactions Transaction[]

  @@index([merchant_id])
  @@map("invoices")
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

model Transaction {
  id                String            @id @default(cuid())
  tx_hash           String            @unique
  payment_link_id   String?
  invoice_id        String?
  merchant_id       String
  sender_address    String
  recipient_address String
  amount_satoshis   BigInt
  confirmations     Int               @default(0)
  status            TransactionStatus @default(PENDING)
  block_height      Int?
  token_category    String?
  usd_rate_at_time  Float?
  created_at        DateTime          @default(now())

  merchant     Merchant     @relation(fields: [merchant_id], references: [id])
  payment_link PaymentLink? @relation(fields: [payment_link_id], references: [id])
  invoice      Invoice?     @relation(fields: [invoice_id], references: [id])

  @@index([merchant_id])
  @@index([payment_link_id])
  @@index([invoice_id])
  @@map("transactions")
}

enum WebhookStatus {
  PENDING
  DELIVERED
  FAILED
}

model Webhook {
  id              String        @id @default(cuid())
  merchant_id     String
  event_type      String
  payload         Json
  status          WebhookStatus @default(PENDING)
  attempts        Int           @default(0)
  last_attempt_at DateTime?

  merchant Merchant @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@map("webhooks")
}

model ApiKey {
  id          String    @id @default(cuid())
  merchant_id String
  key_hash    String
  key_prefix  String    @default("")
  label       String
  permissions Json
  last_used_at DateTime?
  active      Boolean   @default(true)
  created_at  DateTime  @default(now())

  merchant Merchant @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@index([key_prefix])
  @@map("api_keys")
}

enum DevicePlatform {
  IOS
  ANDROID
}

model Device {
  id           String         @id @default(cuid())
  merchant_id  String
  device_token String
  platform     DevicePlatform
  active       Boolean        @default(true)
  created_at   DateTime       @default(now())

  merchant Merchant @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@map("devices")
}

enum CashtokenPurpose {
  LOYALTY
  RECEIPT
  REWARD
}

model CashtokenConfig {
  id             String           @id @default(cuid())
  merchant_id    String
  token_category String
  token_name     String
  token_symbol   String
  token_decimals Int              @default(0)
  purpose        CashtokenPurpose
  active         Boolean          @default(true)
  created_at     DateTime         @default(now())

  merchant Merchant @relation(fields: [merchant_id], references: [id])
  issuances TokenIssuance[]
  receipts  ReceiptNFT[]

  @@index([merchant_id])
  @@map("cashtoken_configs")
}

model TokenIssuance {
  id               String   @id @default(cuid())
  config_id        String
  merchant_id      String
  customer_address String
  amount           BigInt
  tx_hash          String?
  created_at       DateTime @default(now())

  config   CashtokenConfig @relation(fields: [config_id], references: [id])
  merchant Merchant        @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@index([config_id])
  @@map("token_issuances")
}

model ReceiptNFT {
  id               String   @id @default(cuid())
  config_id        String?
  merchant_id      String
  customer_address String
  nft_category     String
  commitment       String
  tx_hash          String?
  mint_tx_hash     String?
  amount_satoshis  BigInt
  memo             String?
  created_at       DateTime @default(now())

  config   CashtokenConfig? @relation(fields: [config_id], references: [id])
  merchant Merchant         @relation(fields: [merchant_id], references: [id])

  @@index([merchant_id])
  @@index([nft_category])
  @@map("receipt_nfts")
}

enum ContractType {
  ESCROW
  SPLIT_PAYMENT
  SAVINGS_VAULT
}

enum ContractStatus {
  ACTIVE
  FUNDED
  RELEASED
  REFUNDED
  DISPUTED
  COMPLETED
  EXPIRED
}

model ContractInstance {
  id               String         @id @default(cuid())
  merchant_id      String
  contract_type    ContractType
  contract_address String
  token_address    String?
  constructor_args Json
  status           ContractStatus @default(ACTIVE)
  created_at       DateTime       @default(now())

  merchant      Merchant      @relation(fields: [merchant_id], references: [id])
  payment_links PaymentLink[]

  @@index([merchant_id])
  @@index([contract_address])
  @@map("contract_instances")
}

enum CheckoutSessionStatus {
  OPEN
  COMPLETE
  EXPIRED
}

model CheckoutSession {
  id              String                @id @default(cuid())
  merchant_id     String
  payment_link_id String?
  amount_satoshis BigInt
  currency        String                @default("USD")
  memo            String?
  success_url     String
  cancel_url      String
  status          CheckoutSessionStatus @default(OPEN)
  expires_at      DateTime
  created_at      DateTime              @default(now())

  merchant     Merchant     @relation(fields: [merchant_id], references: [id])
  payment_link PaymentLink? @relation(fields: [payment_link_id], references: [id])

  @@index([merchant_id])
  @@map("checkout_sessions")
}
